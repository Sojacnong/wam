<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>donationSearch</title>
    <style>
        .body-wrapper>.tag-box{
            border: none;
            margin: 0;
            justify-content: left;
            padding-bottom: 15px;
        }
        .donation-list-box>.donation-list{
            margin-top: 35px;
        }
    </style>
<body>
<!-- header 영역 참조 -->
<header th:insert="~{/common/header :: header}"></header>

<div class="donationList-wrapper page-content">
    <div class="contBox">
        <div class="list-header"><span>후원하기</span></div>
        <div class="donationList-body">
            <div class="body-wrapper">
                <div class="tag-box">
                    <div id="mml" class="tag home-btn">#포유류</div>
                    <div id="bird" class="tag home-btn">#조류</div>
                    <div id="amnrp" class="tag home-btn">#양서파충류</div>
                    <div id="fishes" class="tag home-btn">#어류</div>
                    <div id="etc" class="tag home-btn">#etc</div>
                </div>
                <div class="inputBox">
                    <div class="searchBox">
                        <!-- QnA 검색창 name : DL-search -->
                        <input type="text" class="search input-form" name="DL-search" placeholder="검색어를 입력해주세요.">
                        <button id="search-btn" class="btn bc3">Search</button>
                    </div>
                    <button class="writer-btn btn bc2">
                        <div>
                            <span class="material-symbols-outlined">edit</span>
                            <span>글쓰기</span>
                        </div>
                    </button>
                </div>
                <div class="donation-list-box">
                    <div class="donation-list">
                        <div class="donation-line">
                        </div>
                    </div>
                    <a href="#" class="more-btn home-btn">더보기</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- footer 영역 참조 -->
<footer th:insert="~{/common/footer :: footer}"></footer>

<script th:src="@{/js/donation/donationList.js}"></script>
<script>
    /*URL에서 매개변수 추출 함수*/
    function getQueryParams() {
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const search = urlParams.get('search');
        console.log(search);
        return { search };
    }

    /*후원 검색 목록 조회*/
    loadList(0);   //첫 번째 페이지 후원 목록 불러옴

    //후원 검색 목록을 테이블에 표시하는 함수
    function loadList(page) {
        const { search } = getQueryParams();
        document.querySelector('.search').value = search;   //검색창에 검색어 설정

        axios.get('/support/search/tc', {
            params: {
                keyword: search,
                page: 0
            }
        })
        .then(function(response) {
            if (response.data.content.length === 0) {
                //검색 결과가 없는 경우
                alert('검색 결과가 없습니다.');
                window.location.href = "/support/list";
                return;
            }

            //서버로부터 받은 데이터를 테이블에 추가
            var searchList = response.data.content;

            searchList.forEach(function(support) {
                //graph의 width 설정(목표금액의 몇 퍼센트 모였는지 보여줌)
                const progress = (support.supportAmount / support.goalAmount) * 100;
                const graphWidth = progress > 100 ? '100%' : progress + '%';
                const graph = '<div class="graph" style="width: ' + graphWidth + ';"></div>';

                var row = `<div class="donation-box">
                                <div class="donation-img-box">
                                        <div class="donation-status start">
                                            ${support.supportStatus === 'START' ? '후원 시작' :
                                            support.supportStatus === 'SUPPORTING' ? '후원중' :
                                            support.supportStatus === 'ENDING_SOON' ? '종료 임박' :
                                            support.supportStatus === 'END' ? '후원 종료' : ''}
                                        </div>
                                    <div class="donation-img"><img src="${support.firstImg}" class="first-pic" alt="animal"></div>
                                </div>
                                <a href="/support/detail/${support.supportId}" class="donation-title title-hover">${support.title}</a>
                                <div class="donation-nickname gray-text">${support.nickname}</div>
                                <div class="donation-amount">
                                    <div class="percent">
                                        ${graph}
                                        <div class="graph-bottom"></div>
                                    </div>
                                    <p class="support-amount"><span>${support.supportAmount}</span>원</p>
                                </div>
                            </div>`;

                document.querySelector('.donation-line').innerHTML += row;
            });

            //페이지 내비게이션 업데이트
            //renderPagination(response.data.totalPages, page);
        })
        .catch(function(error) {
            console.error(error);
        });
    }
</script>
</body>
</html>