<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>좋아요 목록</title>
</head>
<body>
<!-- header 영역 참조 -->
<header th:insert="~{/common/header :: header}"></header>

<div class="likeList-wrapper page-content">
    <!-- mypageMenu 영역 참조 -->
    <div th:insert="~{mypage/mypageMenu :: mypageMenu}"></div>

    <div class="list-wrapper mypage-detail">
        <div class="likeList-top list-top">
            <div class="list-title">나의 좋아요 목록</div>
            <table id="likeTable">
                <tr>
                    <th class="th-id">No</th>
                    <th>제목</th>
                    <th class="th-writer">작성자</th>
                    <th class="th-create-date">작성일</th>
                    <th class="th-status">상태</th>
                    <th class="th-delete-btn"></th>
                </tr>
                <tbody id="likeTableBody">
            </table>
            <div class="w3-center">
                <ul id="pagination" class="w3-pagination"></ul>
            </div>
        </div>
        <div class="list-bottom">
        </div>
    </div>
</div>

<!-- footer 영역 참조 -->
<footer th:insert="~{/common/footer :: footer}"></footer>

<script th:src="@{/js/common/pagination.js}"></script>
<script>
    /*나의 좋아요 목록 조회*/
    loadList(0);

    //좋아요한 목록을 테이블에 표시하는 함수
    function loadList(pageNo) {
        axios.get(`/member/like-detail`, {
            headers: {
                'Authorization': 'Bearer ' + token
            },
            params: {
                pageNo: pageNo
            }
        }).then(function(response) {
            //서버로부터 받은 데이터를 테이블에 추가
            var likeList = response.data.content;
            var tableBody = document.querySelector('#likeTableBody');

            //DocumentFragment 생성
            var fragment = new DocumentFragment();

            likeList.forEach(function(like) {
                var row = `<tr>
                            <td>${like.supportId}</td>
                            <td><a href="/support/detail/${like.supportId}" class="title-hover">${like.title}</a></td>
                            <td>${like.nickname}</td>
                            <td>${like.createDate}</td>
                            <td>
                                <button class="answer-btn btn bs1 bc3 style="cursor: default;">
                                    ${like.supportStatus === 'START' ? '후원 시작'
                                    : like.supportStatus === 'SUPPORTING' ? '후원중'
                                    : like.supportStatus === 'ENDING_SOON' ? '종료임박'
                                    : '후원 종료'}
                                </button>
                            </td>
                            <td><button class="deleteLike-btn btn bs1 bc6">삭제</button></td>
                        </tr>`;
                var tr = document.createElement('tr');
                tr.innerHTML = row;

                fragment.appendChild(tr);
            });

            //테이블 내용을 한 번에 추가
            tableBody.innerHTML = '';
            tableBody.appendChild(fragment);

            //페이지 내비게이션 업데이트
            renderPagination(response.data.totalPages, pageNo);

            //삭제 버튼에 이벤트 리스너 추가
            tableBody.querySelectorAll('.deleteLike-btn').forEach(function(button) {
                button.addEventListener('click', function() {
                    var supportId = this.parentNode.parentNode.firstElementChild.textContent;
                    console.log('삭제할 후원: ' + supportId);

                    if (confirm("정말로 좋아요를 삭제하시겠습니까?")) {
                        //사용자가 확인을 누르면 좋아요 삭제 요청
                        axios.delete('/support/' + supportId + '/like', {
                            headers: {
                                'Authorization': 'Bearer ' + token
                            }
                        }).then(function(response) {
                            console.log(response.data);
                            alert(response.data);
                            loadLikeList(pageNo); //페이지 로드
                        })
                        .catch(function(error) {
                            console.error('좋아요 삭제 실패', error);
                            alert(error.response.data.message);
                        });
                    }
                });
            });
        }).catch(function(error) {
            console.error(error);
        });
    }
</script>
</body>
</html>